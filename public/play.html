<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>在线学英语</title>
    <style>
        @import url('css/style.css');
    </style>
    <style>
        * {
            font-family: Arial;
        }

        .highlight {
            color: blue !important;
            font-weight: bold;
        }

        .newWord {
            color: #f7b52a;
            font-weight: bold;
        }

        .script {
            cursor: pointer;
            display: inline-block;
        }

        .script:hover {
            font-weight: bold;
            background-color: #edc;
        }

        .subtitle {
            text-align: left;
            color: #666;
            font-family: Arial;
            line-height: 2rem;
        }

        .header {
            background-color: #f7b52a;
            border: solid 1px #f7b52a;
        }
    </style>
    <style>
        .fluid {
            width: 100%;
        }

        .padded {
            padding: 16px;
        }

        .white.title {
            color: white;
            font-weight: bold;
            text-align: left;
        }

        .full.screen.container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .center.aligned.container {
            text-align: center;
            margin: 0 auto;
        }

        .center.column {
            width: 800px;
        }

        .right.floated {
            float: right;
        }

        .avatar {
            border-radius: 50%;
            max-height: 30px;
        }
    </style>
    <style>
        ul.horizontal.menu {
            display: flex;
            align-items: center;
            list-style-type: none;
            padding: 0;
            margin: -5px 0 0 0;
        }

        ul.horizontal.menu li {
            padding: 0 10px;
        }

        ul.white.horizontal.menu {
            color: white;
        }

        ul.large.menu {
            font-size: larger;
        }
    </style>
</head>
<body ng-app="buzzModule" ng-controller="videoCtrl" class="full screen container">
<div class="fluid container header">
    <div class="center aligned container column">
        <ul class="large right floated white horizontal menu">
            <li>
                <span class="icon-spinner11"></span>
            </li>
            <li>
                <span class="icon-file-text"></span>
            </li>
            <li>
                <img src="https://avatars3.githubusercontent.com/u/3367820?v=3&s=460" class="avatar">
            </li>
        </ul>
        <p class="white title">Hello Shirly, today is the 100st day since you joined NEWS.</p>
    </div>
</div>
<div class="center aligned container column">
    <div><br></div>
    <div class="video" style="width: 100%;">
        <video ng-src="{{src}}" width="320" height="240" controls style="width: 100%; height: auto;" id="main-video"
               type='video/mp4'>
            <!-- <source ng-src='{{trustSrc(videoUrl)}}' type='video/mp4'/> -->
            <!-- <source src='http://blob.bridgeplus.cn/EF_HD.webm'
                    type='video/webm; codecs="vp8, vorbis"'>
            <source src='http://blob.bridgeplus.cn/EF_HD.ogv'
                    type='video/ogv; codecs="theora, vorbis"'> -->
            <object id="flowplayer"
                    data="http://blob.bridgeplus.cn/flowplayer-3.2.2.swf"
                    type="application/x-shockwave-flash" width="320" height="240">
                <param name="movie"
                       value="blob.bridgeplus.cn/flowplayer-3.2.2.swf">
                <param name="allowfullscreen" value="true">
                <param name="flashvars"
                       value="config={'clip':{'url':'http://blob.bridgeplus.cn/EF_HD.mp4','autoPlay':false}}">
            </object>
        </video>
    </div>
    <div class="subtitle">
        <h2>EF中国招聘及员工发展总监</h2>
        <p ng-repeat="st in subtitles">
            <a class="script" ng-class="{'highlight': currentTime >= startTime&&currentTime < o.endTime}"
               ng-click="playTo(startTime)"
               ng-repeat="(startTime, o) in st">
                <span ng-repeat="p in o.textArray" ng-class="{'newWord': p.newWord}">{{p.val}}</span>
            </a>
        </p>
    </div>
</div>
<script src="http://cdn.bridgeplus.cn/bower/angular/angular.min.js?4.0.2_20161106_0316"></script>
<script>
    angular.module('buzzModule', [])
            .controller('videoCtrl', ['$scope', '$interval', '$http', '$sce', function ($scope, $interval, $http, $sce) {
                let searchStr = location.search.substr(1);
                let queryAry = searchStr.split("&");
                let queryObj = {};
                queryAry.forEach(function (val) {
                    var valAry = val.split("=");
                    queryObj[valAry[0]] = valAry[1];
                });
                var urlhead = `http://buzz-course-video.b0.upaiyun.com/news/${queryObj.cat}/${queryObj.date}-${queryObj.level}`;
                let videoUrl = urlhead + "-1080w.mp4";
                $scope.src = $sce.trustAsResourceUrl(videoUrl);
                $http.get(urlhead + ".ass").then(function (ret) {
                    let data = ret.data;
                    let dataArray = data.split("Dialogue:");
                    dataArray.shift();
                    $scope.subtitles = [];
                    const standard = Date.UTC(1, 1, 1, 0);
                    let toSecond = function (time) {
                        var timeAry = time.split(":");
                        return (Date.UTC(1, 1, 1, timeAry[0], timeAry[1], timeAry[2].split(".")[0]) - standard) / 1000;
                    }
                    var obj = {};
                    var subtitles = [];
                    var endTime = "";
                    dataArray.forEach(function (target) {
                        var targetAry = target.split(",");
                        var thisEndTime = toSecond(targetAry[2]).toString();
                        if (endTime !== thisEndTime) {
                            endTime = thisEndTime;
                            obj = {};
                            $scope.subtitles.push(obj);
                        }
                        var tmpText = targetAry.slice(9).join(",");
                        var targetText = tmpText.split('\n')[0];
                        var textArray = targetText.split("{");
                        var displayTextArray = [];
                        if (textArray.length === 1) {
                            displayTextArray.push({
                                val: textArray[0],
                                newWord: false
                            });
                        } else {
                            textArray.forEach(function (textVal) {
                                if (textVal !== "") {
                                    var bb = textVal.split("}");
                                    if (bb.length === 1) {
                                        displayTextArray.push({
                                            val: bb[0],
                                            newWord: false
                                        });
                                    } else {
                                        displayTextArray.push({
                                            val: bb[0],
                                            newWord: true
                                        });
                                    }
                                    if (bb[1] && bb[1] !== "") {
                                        displayTextArray.push({
                                            val: bb[1],
                                            newWord: false
                                        });
                                    }
                                }
                            })
                        }
                        obj[toSecond(targetAry[1]).toString()] = {
                            endTime: thisEndTime,
                            textArray: displayTextArray
                        };
                    });
                });
                var mainVideo = document.getElementById('main-video');

                $scope.currentTime = Math.round(mainVideo.currentTime);
                var intervalPromise = null;

                mainVideo.onpause = function () {
                    $interval.cancel(intervalPromise);
                };

                mainVideo.onplay = function () {
                    intervalPromise = $interval(function () {
                        $scope.currentTime = Math.round(mainVideo.currentTime);
                        console.log($scope.currentTime);
                    }, 500);
                };

                $scope.playTo = function (time) {
                    var video = mainVideo;
                    video.currentTime = time;
                    video.play();
                };
            }]);
</script>
</body>
</html>