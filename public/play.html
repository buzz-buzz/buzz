<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <!--<link rel="stylesheet" type="text/css" href="/fullpage.js/dist/jquery.fullpage.min.css">-->
    <title>Buzz English</title>
    <style>
        @import url('css/style.css');
    </style>
    <style>
        * {
            font-family: Arial;
        }

        .highlight {
            color: blue !important;
        }

        .newWord {
            color: #f7b52a;
            font-weight: bold;
        }

        .script {
            cursor: pointer;
            display: inline-block;
        }

        .script:hover {
            /*background-color: #edc;*/
        }

        .subtitle {
            text-align: left;
            color: #666;
            font-family: Arial;
            line-height: 2rem;
            overflow: auto;
        }

        .header {
            background-color: #f7b52a;
            border: solid 1px #f7b52a;
        }

        .fixed {
            position: fixed;
            z-index: 1;
        }
    </style>
    <style>
        .fluid {
            width: 100%;
        }

        .padded {
            padding: 16px;
        }

        .white.title {
            color: white;
            font-weight: bold;
            text-align: left;
        }

        .full.screen.container {
            width: 100%;
            /*height: 100%;*/
            margin: 0 0 0 0;
            padding: 0;
        }

        .center.aligned.container {
            text-align: center;
            margin: 0 auto;
        }

        .white.background {
            background-color: white;
        }

        .center.column {
            width: 900px;
            border-left: solid 1px #ddd;
            border-right: solid 1px #ddd;
        }

        .right.floated {
            float: right;
        }

        .avatar {
            border-radius: 50%;
            max-height: 30px;
        }

        .page.with-header {
            padding-top: 50px;
        }

        .page {
            height: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .bordered.segment {
            border: solid 1px #eee;
            border-bottom: solid 2px #ccc;
            margin: 10px 15px;
            padding: 0 20px 20px 20px;
        }
    </style>
    <style>
        ul.horizontal.menu {
            display: flex;
            align-items: center;
            list-style-type: none;
            padding: 0;
            margin: -5px 0 0 0;
        }

        ul.horizontal.menu li {
            padding: 0 10px;
        }

        ul.white.horizontal.menu {
            color: white;
        }

        ul.large.menu {
            font-size: larger;
        }

        ul.menu li {
            cursor: pointer;
        }

        ul.menu li.active {
            font-weight: bold;
        }
    </style>
    <style>
        /* http://stackoverflow.com/questions/90178/make-a-div-fill-the-height-of-the-remaining-screen-space */
        .flex-box {
            display: flex;
            flex-flow: column;
            height: 100%;
        }

        .flex-box .row {
        }

        .flex-box .row.dynamic {
            flex: 0 1 auto;
        }

        .flex-box .row.content {
            flex: 1 1 auto;
        }
    </style>
    <style>
        @media screen and (max-height: 750px) {
            #main-video {
                width: 80% !important;
            }
        }

        @media screen and (max-height: 550px) {
            #main-video {
                width: 50% !important;
            }
        }
    </style>
    <style>
        .tabular.menu {
            border-bottom: solid 1px #f7b52a;
        }

        .tabular.menu .item {
            display: inline-block;
            width: 33%;
            cursor: pointer;
            color: #666;
            padding-top: 0.8em;
            padding-bottom: 0.8em;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }

        .tabular.menu .item.middle {
            width: 34%;
        }

        .tabular.menu .item:hover {
        }

        .tabular.menu .item.active {
            background-color: #f7b52a;
            color: white;
        }

        .tabular.menu .item .icon {
            margin-right: 0.2em;
            vertical-align: text-top;
        }

        .tabular.content {
            padding-top: 4em;
        }

        .tabular.content .item {
        }

        .tabular.content .item .arrow {
            display: inline-block;
            font-size: 2em;
            color: #f7b52a;
            cursor: pointer;
            padding: 0 1.6em;
        }

        .tabular.content .item .vocabulary.container {
            display: inline-block;
            width: 60%;
            vertical-align: middle;
            padding-bottom: 1em;
        }

        .tabular.content .item .vocabulary.container .item {
            background-color: #f5f5f5;
            min-height: 100px;
            padding: 2em;
            text-align: left;
        }

        .tabular.content .item .vocabulary.container .item .head .word {
            color: #ff6e00;
        }

        .tabular.content .item .vocabulary.container .item .body {
            color: #666;
        }

        .tabular.content .item .vocabulary.container .item .body .explanation {
            margin: 1em 0;
        }

        .tabular.content .item .vocabulary.container .item .body .explanation .title {
            color: #bcbcbc;
        }

        .tabular.content .item .vocabulary.container .item .body .explanation .body {
            display: inline-block;
            width: 85%;
            vertical-align: text-top;
        }

        .playsound-volume-icon {
          color: orange;
          cursor: pointer;
        }

        .effect2 {
            position: relative;
        }

        .effect2:before, .effect2:after {
            z-index: -1;
            position: absolute;
            content: "";
            bottom: 15px;
            left: 10px;
            width: 50%;
            top: 80%;
            max-width: 300px;
            background: #777;
            -webkit-box-shadow: 0 15px 10px #777;
            -moz-box-shadow: 0 15px 10px #777;
            box-shadow: 0 15px 10px #777;
            -webkit-transform: rotate(-3deg);
            -moz-transform: rotate(-3deg);
            -o-transform: rotate(-3deg);
            -ms-transform: rotate(-3deg);
            transform: rotate(-3deg);
        }

        .effect2:after {
            -webkit-transform: rotate(3deg);
            -moz-transform: rotate(3deg);
            -o-transform: rotate(3deg);
            -ms-transform: rotate(3deg);
            transform: rotate(3deg);
            right: 10px;
            left: auto;
        }
    </style>
    <style>
        body {
            background: url('/images/skin.png') repeat-x 0 0;
            background-size: contain;
        }
    </style>
</head>
<body ng-app="buzzModule" ng-controller="videoCtrl" class="full screen container">
<div class="fluid container header fixed">
    <div class="center aligned container column" style="border: none;">
        <ul class="large right floated white horizontal menu">
            <li>
                <span class="icon-spinner11"></span>
            </li>
            <li>
                <span class="icon-file-text"></span>
            </li>
            <li>
                <img src="https://avatars3.githubusercontent.com/u/3367820?v=3&s=460" class="avatar">
            </li>
        </ul>
        <p class="white title">Hello Shirly, today is the 100st day since you joined NEWS.</p>
    </div>
</div>
<div id="fullpage">
    <a name="page-1" class="page-pos"></a>
    <div class="page with-header section">
        <div class="center aligned container column flex-box white background">
            <div class="video row dynamic" style="width: 100%;">
                <p>&nbsp;
                    <span class="right floated" style="color: #666; font-size: small;">
                        {{today | date}}
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </span>
                </p>
                <div style="width: 100%;  background-color: black;">
                    <video ng-src="{{src}}" width="320" height="240" controls style="width: auto; height: 50%;"
                           id="main-video"
                           type='video/mp4'>
                    </video>
                </div>
                <div>
                    <div><br></div>
                    <ul class="horizontal menu">
                        <li ng-class="{'active': definition === '360w'}">
                            <a ng-click="definition = '360w'">普清</a>
                        </li>
                        <li ng-class="{'active': definition === '1080w'}">
                            <a ng-click="definition = '1080w'">高清</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="subtitle row content" style="display: flex;">
                <div class="bordered segment" style="max-height: 100%; width: 100%; overflow: auto;">
                    <h2>Buzz English</h2>
                    <p ng-repeat="st in subtitles">
                        <a class="script" ng-class="{'highlight': currentTime >= startTime&&currentTime < o.endTime}"
                           ng-click="playTo(startTime)"
                           ng-repeat="(startTime, o) in st">
                            <span ng-repeat="p in o.textArray" ng-class="{'newWord': p.newWord}">{{p.val}}</span>
                        </a>
                        <a class="icon-volume-medium playsound-volume-icon" ng-click="playTo(startTime)"
                           ng-repeat="(startTime, o) in st" ng-if="$index === 0"></a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <a name="page-2" class="page-pos"></a>
    <div class="page with-header section">
        <br>
        <div class="center aligned container column white background">
            <div class="tabular menu">
                <div class="item" ng-class="{'active': tabularIndex===1}" ng-click="tabularIndex=1">
                    <span class="icon icon-list2"></span>
                    <span> Daily Exercise </span>
                </div><!--
              --><div class="item middle" ng-class="{'active': tabularIndex===2}" ng-click="tabularIndex=2">
                    <span class="icon icon-list2"></span>
                    <span> Today's Vocabulary </span>
                </div><!--
                --><div class="item" ng-class="{'active': tabularIndex===3}" ng-click="tabularIndex=3">
                    <span class="icon icon-list2"></span>
                    <span> Weekly Quiz </span>
                </div>
            </div>
            <div class="tabular content">
                <div class="item" ng-show="tabularIndex===1">
                    item1
                </div>
                <div class="item" ng-show="tabularIndex===2">
                    <div class="left arrow">
                        <span class="icon-circle-left"></span>
                    </div>
                    <div class="vocabulary container">
                        <div class="item effect2">
                            <div class="head">
                                <span class="word">act</span>
                                <span class="ipa">[ækt]</span>
                                <i class="icon-volume-medium playsound-volume-icon"></i>
                            </div>
                            <div class="body">
                                <div class="explanation">
                                    <span class="title">释义:</span>
                                    <div class="body">n. 行为，法令;vt&amp;vi. 行动;表演;起作用</div>
                                </div>
                                <div class="explanation">
                                    <span class="title">构词:</span>
                                    <div class="body">act行动，活动，做-->v.行动，行为，扮演 n.[戏]幕</div>
                                </div>
                                <div class="explanation">
                                    <span class="title">例句:</span>
                                    <div class="body">
                                        <div>
                                            <span>Her five-year-old daughter likes to act up before socres of vistors.</span>
                                            <i class="icon-volume-medium playsound-volume-icon"></i>
                                        </div>
                                        <div>
                                            她那五岁的小女儿喜欢在很多的客人面前表演.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="right arrow">
                        <span class="icon-circle-right"></span>
                    </div>
                </div>
                <div class="item" ng-show="tabularIndex===3">
                    item3
                </div>
            </div>
        </div>
    </div>
</div>
<script src="http://cdn.bridgeplus.cn/bower/angular/angular.min.js?4.0.2_20161106_0316"></script>
<script>
    angular.module('buzzModule', [])
            .controller('videoCtrl', ['$scope', '$interval', '$http', '$sce', function ($scope, $interval, $http, $sce) {
                $scope.tabularIndex = 1;
                let searchStr = location.search.substr(1);
                let queryAry = searchStr.split("&");
                let queryObj = {};
                queryAry.forEach(function (val) {
                    var valAry = val.split("=");
                    queryObj[valAry[0]] = valAry[1];
                });
                var urlhead = `http://buzz-course-video.b0.upaiyun.com/news/${queryObj.cat}/${queryObj.date}-${queryObj.level}`;

                $scope.definition = '1080w';

                $scope.$watch('definition', function (newValue, oldValue) {
                    var videoUrl = urlhead + "-" + $scope.definition + ".mp4";
                    $scope.src = $sce.trustAsResourceUrl(videoUrl);
                });

                $http.get(urlhead + ".ass").then(function (ret) {
                    let data = ret.data;
                    let dataArray = data.split("Dialogue:");
                    dataArray.shift();
                    $scope.subtitles = [];
                    const standard = Date.UTC(1, 1, 1, 0);
                    let toSecond = function (time) {
                        var timeAry = time.split(":");
                        return (Date.UTC(1, 1, 1, timeAry[0], timeAry[1], timeAry[2].split(".")[0]) - standard) / 1000;
                    };
                    var obj = {};
                    var endTime = "";
                    dataArray.forEach(function (target) {
                        var targetAry = target.split(",");
                        var thisEndTime = toSecond(targetAry[2]).toString();
                        if (endTime !== thisEndTime) {
                            endTime = thisEndTime;
                            obj = {};
                            $scope.subtitles.push(obj);
                        }
                        var tmpText = targetAry.slice(9).join(",");
                        var targetText = tmpText.split('\n')[0];
                        var textArray = targetText.split("{");
                        var displayTextArray = [];
                        if (textArray.length === 1) {
                            displayTextArray.push({
                                val: textArray[0],
                                newWord: false
                            });
                        } else {
                            textArray.forEach(function (textVal) {
                                if (textVal !== "") {
                                    var bb = textVal.split("}");
                                    if (bb.length === 1) {
                                        displayTextArray.push({
                                            val: bb[0],
                                            newWord: false
                                        });
                                    } else {
                                        displayTextArray.push({
                                            val: bb[0],
                                            newWord: true
                                        });
                                    }
                                    if (bb[1] && bb[1] !== "") {
                                        displayTextArray.push({
                                            val: bb[1],
                                            newWord: false
                                        });
                                    }
                                }
                            })
                        }
                        obj[toSecond(targetAry[1]).toString()] = {
                            endTime: thisEndTime,
                            textArray: displayTextArray
                        };
                    });
                });
                var mainVideo = document.getElementById('main-video');

                $scope.currentTime = Math.round(mainVideo.currentTime);
                var intervalPromise = null;

                mainVideo.onpause = function () {
                    $interval.cancel(intervalPromise);
                };

                mainVideo.onplay = function () {
                    intervalPromise = $interval(function () {
                        $scope.currentTime = Math.round(mainVideo.currentTime);
                        console.log($scope.currentTime);
                    }, 500);
                };

                $scope.playTo = function (time) {
                    var video = mainVideo;
                    video.currentTime = time;
                    video.play();
                };

                $scope.today = new Date();
            }]);
</script>
<!--<script src="/js/fullpage.js"></script>-->
</body>
</html>
